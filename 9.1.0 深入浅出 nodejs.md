# 深入浅出 nodejs


- 1.事件循环，观察者，请求对象， I/O线程池 共同构成 Node 异步 I/O 模型的基本要素

- 2.非 I/O 的异步 API
  - setTimeout()
  - setInterval()
  - setImmediate()
  - process.nextTick()
- [more](https://github.com/fairyly/mynodejs/blob/gh-pages/README.md#node-%E5%BC%82%E6%AD%A5-io) 
  
- 3.异步编程解决方案
  - 事件发布、订阅者模式
  - Promise/Deferred 模式
  - 流程控制库
  
## 事件发布、订阅者模式

基本事件：

- adaListener/on()
- emit()
- once()
- removeListener()
- removeAllListeners()

example:

```
var events = require('events');
var emitter = new events.EventEmitter()
// 订阅
emitter.on('eventName',function(msg){
  console.log(msg)
})

// 发布
emitter.emit('eventName','msg content')
```

EventProxy: 

- https://github.com/JacksonTian/eventproxy

example:

```
var EventProxy = require('eventproxy');
var ep = new EventProxy();
ep.all('tpl', 'data', function (tpl, data) { // or ep.all(['tpl', 'data'], function (tpl, data) {})
  // 在所有指定的事件触发后，将会被调用执行
  // 参数对应各自的事件名
});
fs.readFile('template.tpl', 'utf-8', function (err, content) {
  ep.emit('tpl', content);
});
db.get('some sql', function (err, result) {
  ep.emit('data', result);
});

all方法将handler注册到事件组合上。当注册的多个事件都触发后，将会调用handler执行，每个事件传递的数据，将会依照事件名顺序，传入handler作为参数。

重复异步协作:

var ep = new EventProxy();
ep.after('got_file', files.length, function (list) {
  // 在所有文件的异步执行结束后将被执行
  // 所有文件的内容都存在list数组中
});
for (var i = 0; i < files.length; i++) {
  fs.readFile(files[i], 'utf-8', function (err, content) {
    // 触发结果事件
    ep.emit('got_file', content);
  });
}

after方法适合重复的操作，比如读取10个文件，调用5次数据库等。将handler注册到N次相同事件的触发上。达到指定的触发数，handler将会被调用执行，每次触发的数据，将会按触发顺序，存为数组作为参数传入

持续型异步协作:

var ep = new EventProxy();
ep.tail('tpl', 'data', function (tpl, data) {
  // 在所有指定的事件触发后，将会被调用执行
  // 参数对应各自的事件名的最新数据
});
fs.readFile('template.tpl', 'utf-8', function (err, content) {
  ep.emit('tpl', content);
});
setInterval(function () {
  db.get('some sql', function (err, result) {
    ep.emit('data', result);
  });
}, 2000);

tail与all方法比较类似，都是注册到事件组合上。不同在于，指定事件都触发之后，如果事件依旧持续触发，将会在每次触发时调用handler，极像一条尾巴。
```

## Promise/Deferred 模式

```

```

## 参考
- 理解 Node.js 里的 process.nextTick() : https://www.oschina.net/translate/understanding-process-next-tick
