# 使用 `Hapi` 开发 `RESTful APIs`
搜了国内的 使用 `Hapi` 开发 `RESTful API` 的很少很少，一些 社区介绍的部分在新版本中已经不在适用，新版本中有很多变化

## 什么是 `RESTful API`
>RESTful API:REST -- REpresentational State Transfer，英语的直译就是“表现层状态转移”

可以参考下面理解： 
- 理解本身的 REST 架构风格：http://www.infoq.com/cn/articles/understanding-restful-style/

- 理解 RESTful 架构：http://www.ruanyifeng.com/blog/2011/09/restful.html

- Restful API 设计指南：http://www.ruanyifeng.com/blog/2014/05/restful_api.html

## Hapi
  Hapi 是一个 Node.js 的 web 框架，即一个构建应用程序和服务丰富的框架。
  目前 Hapi v17 仅支持 node v8.9.0 及以上版本
- 了解：[Node.js中 hapi-express-restify-koa 性能对比](https://raygun.com/blog/nodejs-vs-hapi-express-restify-koa/)
## Hapi 特性
- 认证和授权：内置的验证和授权方案
- 缓存：提供客户端和服务端缓存，[catbox](https://github.com/hapijs/catbox)
- 路由: 内置路由
- 验证：使用 Joi
- Cookies：提供了配置选项处理 cookie
- 日志：置的日志记录
- 错误处理：[boom](https://github.com/hapijs/boom)
- 进程监控：hapi 插件 [good](https://github.com/hapijs/good)

## 使用 Hapi 的必要条件
- 安装 Node.js v8.9.0 及以上
- 安装 MongoDB
- 熟悉数据库概念和 JavaScript 的应用知识

## Hapi v17 新的变化
- server.connection 方法移除，现在使用
  ```
  const server = new Hapi.Server({
      host: 'localhost',
      port: 3000
  })
  ```
- 开启关闭服务方法 完全异步，没有回调
  ```
  try {
      await server.start()
  }
  catch (err) {
      console.log(err)
  }
    
  try {
      await server.stop()
  }
  catch (err) {
      console.log(err)
  }
  ```

- reply() 回调方法移除,response.hold() 和 response.resume() 方法不在可用
  ```
  // 以前
  const handler = function (request, reply) {
    return reply('ok');
  };

  // 现在

  const handler = function (request, h) {
    return 'ok';
  };
  ```
  更多使用 h 的示例如下：  
  ```
  const handler = (request, h) => {
    // return a string
    return 'ok'

    // return an object and hapi creates JSON out of it
    return { name: 'Authentication Library', library: true }

    // redirect to 404
    return h.redirect('/404')

    // return a view
    return h.view('index', { name: 'Authentication Library' })

    // use the "h" response toolkit to create a response
    return h
     .response(thisHTML)
      .type('text/html')
      .header('X-Custom', 'my-value')
      .code(201)
  }
  ```
- 三个请求事件类型 request, request-interval,  request-error 合并成一个单一的 request 事件
- 触发的方法 像 server.on, request.on, response.on 被替换，使用server.events.on(), request.events.on(), response.events.on() 替代
- 新的请求扩展：
  ```
  server.ext('onPreAuth', (request, h) => { … })
  server.ext('onCredentials', (request, h) => { … })
  server.ext('onPostAuth', (request, h) => { … }) ]
  ```
- 在路由定义的时候 替换 config 为 options
  ```
  server.route({
    method: 'POST',
    path: '/',
    options: { … }
  })
  ```
- 插件
  目前使用 
  ```
  exports.plugin = { register, name, version, multiple, dependencies, once, pkg }
  ```
- 
更多变化详见[GitHub 完整的更新日志](https://github.com/hapijs/hapi/issues/3658)

## 正题：使用 Hapi 构建一个 api

## 参考
- GitHub：https://github.com/hapijs/hapi
- website: https://hapijs.com/
- issue：https://github.com/hapijs/discuss/issues
- [developing-restful-apis-with-hapi v17](https://auth0.com/blog/developing-restful-apis-with-hapijs/)
- https://github.com/hapijs/hapi/issues/3658
## 仅供学习交流
